<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-0.9.243">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Vignette: General (non-ML ‘regression’) modeling workflow</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

  <script src="modeling_workflow_files/libs/clipboard/clipboard.min.js"></script>
  <script src="modeling_workflow_files/libs/quarto-html/quarto.js"></script>
  <script src="modeling_workflow_files/libs/quarto-html/popper.min.js"></script>
  <script src="modeling_workflow_files/libs/quarto-html/tippy.umd.min.js"></script>
  <script src="modeling_workflow_files/libs/quarto-html/anchor.min.js"></script>
  <link href="modeling_workflow_files/libs/quarto-html/tippy.css" rel="stylesheet">
  <link id="quarto-text-highlighting-styles" href="modeling_workflow_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="modeling_workflow_files/libs/bootstrap/bootstrap.min.js"></script>
  <link href="modeling_workflow_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="modeling_workflow_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script async="" src="https://hypothes.is/embed.js"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc">
<h2 id="toc-title">Table of contents</h2>
<ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"> <span class="header-section-number">1</span> Introduction</a>
<ul class="collapse">
<li><a href="#reading-in-data-from-a-repo" id="toc-reading-in-data-from-a-repo" class="nav-link" data-scroll-target="#reading-in-data-from-a-repo"> <span class="header-section-number">1.1</span> Reading in data from a repo</a></li>
</ul></li>
<li><a href="#modeling-discussion" id="toc-modeling-discussion" class="nav-link" data-scroll-target="#modeling-discussion"> <span class="header-section-number">2</span> Modeling discussion</a></li>
<li><a href="#choosing-features-and-modeling-targets-defining-these-listsobjects" id="toc-choosing-features-and-modeling-targets-defining-these-listsobjects" class="nav-link" data-scroll-target="#choosing-features-and-modeling-targets-defining-these-listsobjects">Choosing features and modeling targets, defining these lists/objects</a></li>
<li><a href="#ad-hoc-data-cleaning-recipes" id="toc-ad-hoc-data-cleaning-recipes" class="nav-link" data-scroll-target="#ad-hoc-data-cleaning-recipes"> <span class="header-section-number">3</span> Ad-hoc data cleaning, recipes</a>
<ul class="collapse">
<li><a href="#peeking-at-data-for-sanity-checks" id="toc-peeking-at-data-for-sanity-checks" class="nav-link" data-scroll-target="#peeking-at-data-for-sanity-checks"> <span class="header-section-number">3.1</span> Peeking at data for sanity checks</a></li>
</ul></li>
<li><a href="#constructing-and-specifying-models" id="toc-constructing-and-specifying-models" class="nav-link" data-scroll-target="#constructing-and-specifying-models">Constructing and specifying models</a>
<ul class="collapse">
<li><a href="#make-model-data-frames" id="toc-make-model-data-frames" class="nav-link" data-scroll-target="#make-model-data-frames"> <span class="header-section-number">3.2</span> Make ‘model data frames’</a></li>
</ul></li>
<li><a href="#report-model-results" id="toc-report-model-results" class="nav-link" data-scroll-target="#report-model-results"> <span class="header-section-number">4</span> Report model results</a></li>
</ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">
<header id="title-block-header" class="quarto-title-block default">

<div class="quarto-title"><div class="quarto-title-block"><div><h1 class="title">Vignette: General (non-ML ‘regression’) modeling workflow</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div></div></header>

<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This vignette</p>
<ul>
<li><p>shows how I define, build, and report (tables and plots) a set of ‘models’ in a (fairly) tidy, organized way …</p></li>
<li><p>for the simple intuitive/ad-hoc descriptive and causally suggestive models I did for the of the 2020 <a href="https://forum.effectivealtruism.org/posts/nb6tQ5MRRpXydJQFq/ea-survey-2020-series-donation-data">EA Forum post</a> and <a href="https://rethinkpriorities.github.io/ea_data_public/eas_rps_own_style/eas_donations.html">chapter</a> and other EA forum posts posts</p></li>
<li><p>As a code example</p>
<ul>
<li>How the computation works and ‘what is producing what’ … so that you can recreate it in your own context</li>
</ul></li>
<li><p>To give a little bit of insight into the modeling choices and approaches.</p></li>
</ul>
<section id="reading-in-data-from-a-repo" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="reading-in-data-from-a-repo"><span class="header-section-number">1.1</span> Reading in data from a repo</h2>
<p>The code below reads data in directly from the RP private github repo. You need to have authorization set up for this to work.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>Next we sample from this data and remove labels, to make the process quicker and easier.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  labelled<span class="sc">::</span><span class="fu">remove_attributes</span>(<span class="st">"label"</span>) <span class="sc">%&gt;%</span>  <span class="co"># Labels don't work with tidymodels :/, sadly</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">sample_n</span>(<span class="dv">2000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="modeling-discussion" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Modeling discussion</h1>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target="#callout-1" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Brief: our descriptive model ‘selection’
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In our <em>descriptive</em> modeling we do <em>not</em> remove ‘insignificant’ features from the model (as in stepwise regression), nor do we shrink the coefficients towards zero (as in Ridge and Lasso models). Under the assumptions of the classical linear model and its simple extensions the coefficients we present here would be unbiased or consistent. (However, we admit that the strong assumptions of this model, particularly those embodying exogeneity, are likely to fail in important ways in the current non-experimental setting.)</p>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target="#callout-2" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
We retain those features of most direct interest
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>… (such as ‘how introduced to EA’) and/or theoretical importance (such as income), <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and ‘controls’ (especially time-in-EA and survey-year) that might allow us to better interpret the features of interest.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
</div>
</div>
</div>
</section>
<section id="choosing-features-and-modeling-targets-defining-these-listsobjects" class="level1 unnumbered">
<h1 class="unnumbered">Choosing features and modeling targets, defining these lists/objects</h1>
<p><strong>We focus on three key outcomes:</strong></p>
<ol type="1">
<li><p>Amount donated (converted to US dollars)<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p></li>
<li><p>Donation as a share of income<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p></li>
<li><p>Whether donated more than 1000 USD</p></li>
</ol>
<p><strong>We construct several ‘feature sets’:</strong></p>
<ul>
<li>“Key demographics, student status, and geography”, used in all models</li>
<li>“Career/Economics”: (Income, employment status, top-6 university)</li>
</ul>
<!-- ^["Top-6 university" refers to whether the individual lists any of the six universities (Oxford, Stanford, Harvard, CalTech, MIT, Cambridge) appearing in the top-10 of all of USNWR, QS, and THE rankings. However, university was not asked in the 2018 survey ] -->
<ul>
<li><p>“Pledges/commitments:” Whether ever taken a ‘Giving What We Can Pledge’, whether ‘Earning to Give’ <!-- feat_gwwc_etg --></p></li>
<li><p>“Controls” for age, time-in-EA, and survey-year (used in all models) <a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p></li>
</ul>
<p><strong>In the code below, we define these as objects!</strong></p>
<p>We define the lists of the different ‘features’ we care about as character vectors, to put into the models later. The idea is ‘all decisions are specified and discussed up top’, for better organization and control.</p>
<p>First we define the ‘targets’: the binary outcomes, numerical outcomes, all outcomes, and a subset of these outcomes for more involved analyses.</p>
<div class="cell">

</div>
<p>Next, we define the ‘features of interest’ and the ‘controls’</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#features and controls</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>geog <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"where_live_cat"</span>, <span class="st">"city_cat"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>key_demog <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ln_age"</span>, <span class="st">"not_male_cat"</span>, <span class="st">"student_cat"</span>, <span class="st">"race_cat"</span>, geog)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>key_demog_n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age_d2sd"</span>, <span class="st">"not_male_cat"</span>, <span class="st">"student_cat"</span>, <span class="st">"race_cat"</span>, geog)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>feat_income_employ <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ln_income_c_imp_bc5k"</span>, <span class="st">"d_pt_employment"</span>, <span class="st">"d_not_employed"</span>, <span class="st">"d_top6_uni"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Note -income_c_imp_diqr has been adjusted to  with 5k minimum</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>feat_income_employ_n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"income_c_imp_diqr"</span>, <span class="st">"d_pt_employment"</span>, <span class="st">"d_not_employed"</span>, <span class="st">"d_top6_uni"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>feat_gwwc_etg <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"d_gwwc_ever_0"</span>, <span class="st">"d_career_etg"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>controls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ln_years_involved"</span>, <span class="st">"year_f"</span>) <span class="co">#note this assumes those 2009 or earlier started in 2009</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>controls_n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"years_involved_d2sd"</span>, <span class="st">"year_f"</span>) <span class="co">#note this assumes those 2009 or earlier started in 2009</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>robust_controls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ln_years_involved_post_med"</span>,  <span class="st">"ln_age_if_older"</span>, <span class="st">"ln_income_c_imp_if_richer"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>robust_controls_n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"years_inv_d2sd_post_med"</span>,  <span class="st">"age_d2sd_post_med"</span>, <span class="st">"income_c_imp_diqr_if_richer"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">#note -- I swapped "age_ranges" for "gender_d2sd" because this will allow us a decent measure of 'is the age effect nonlinear' (see datacolada on the superiority of this over a quadratic)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">#contrasts(normtimeBP02$Nasality) = contr.treatment(4)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">#DR; I was never able to get the contrasts thing to work so I went with 'base group is most common group'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>key_eas_all_labels <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="co">#note these are converted to a list with as.list before assigning them</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">donation_usd =</span> <span class="st">"Donation (USD)"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">l_don_usd =</span> <span class="st">"Log Don. (USD)"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">l_don_av_2yr =</span> <span class="st">"Log Don. 'avg.'"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ln_age =</span> <span class="st">"Log age"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">don_av2_yr =</span> <span class="st">"Don. 'avg'"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">donation_plan_usd =</span> <span class="st">"Don. plan (USD)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="ad-hoc-data-cleaning-recipes" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Ad-hoc data cleaning, recipes</h1>
<p>We impute a few missings, etc, just for modeling.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<p>Below, some e imputations and constructed features (for functional form interpretation) that I did in the ‘actual analysis’.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#We impute variables where missing and normalizing all variables to be mean-zero and to be on the same scale.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>diqr <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  (x <span class="sc">-</span> <span class="fu">mean</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>))<span class="sc">/</span><span class="fu">IQR</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>gtmed <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">*</span>(x<span class="sc">&gt;</span><span class="fu">med</span>(x))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>eas_all_s <span class="ot">&lt;-</span> eas_all <span class="sc">%&gt;%</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(don_av2_yr) <span class="sc">&amp;</span> year_f <span class="sc">%in%</span> last_3_years) <span class="sc">%&gt;%</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#(re) code scaling and 2-part splits for the modeling sample (2018-20, reporting donations)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_d2sd =</span> arm<span class="sc">::</span><span class="fu">rescale</span>(age), <span class="co">#Todo (automate this with `mutate(across)` thing)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">years_involved_d2sd =</span> arm<span class="sc">::</span><span class="fu">rescale</span>(year <span class="sc">-</span> <span class="fu">as.numeric</span>(year_involved)),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">years_inv_d2sd_post_med =</span> <span class="fu">gtmed</span>(years_involved_d2sd),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">income_c_imp_diqr =</span> <span class="fu">diqr</span>(income_c_imp_bc5k),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_d2sd_post_med =</span> arm<span class="sc">::</span><span class="fu">rescale</span>(age_if_older),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">income_c_imp_diqr_if_richer =</span> <span class="fu">gtmed</span>(income_c_imp_diqr),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">ln_income_c_imp_if_richer=</span> <span class="fu">gtmed</span>(ln_income_c_imp_bc5k)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">don_share_inc_imp_bc5k =</span> <span class="fu">min</span>(don_share_inc_imp_bc5k, <span class="dv">1</span>)) <span class="sc">%&gt;%</span>  <span class="co">#recode about 84 values so the range is between 0-1 for frac. logit to work</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(num_out, bin_out, controls, key_demog, feat_income_employ, feat_gwwc_etg, robust_controls)),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                income_c, income_c_imp, income_c_imp_bc5k, income_c_imp_diqr, income_c_imp_diqr_if_richer, first_hear_ea_lump, years_involved, age,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                <span class="fu">contains</span>(<span class="st">"d2sd"</span>), <span class="fu">contains</span>(<span class="st">"iqr"</span>)) <span class="sc">%&gt;%</span> <span class="co">#I have added first_hear_ea_lump back even though we don't use it here because we want to use it in ML; I hope it doesn't mess anything up</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># years_involved included to put in sumstats</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  labelled<span class="sc">::</span><span class="fu">set_variable_labels</span>(<span class="at">.labels =</span> <span class="fu">as.list</span>(key_eas_all_labels), <span class="at">.strict=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>Error in filter(., !is.na(don_av2_yr) &amp; year_f %in% last_3_years): object 'eas_all' not found</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Recode missing as 0 for all dummies, as a 'NA category' for categoricals</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#also for normalized variables; i.e., set missings to the mean</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>eas_all_s_rl <span class="ot">&lt;-</span> eas_all_s <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"d_|not_just_white"</span>), missing_to_zero))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>Error in mutate(., across(matches("d_|not_just_white"), missing_to_zero)): object 'eas_all_s' not found</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>eas_all_s_rl_imp <span class="ot">&lt;-</span> eas_all_s_rl <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"d2sd|diqr"</span>), missing_to_zero)) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    labelled<span class="sc">::</span><span class="fu">set_variable_labels</span>(<span class="at">.labels =</span> <span class="fu">as.list</span>(key_eas_all_labels), <span class="at">.strict=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>Error in mutate(., across(matches("d2sd|diqr"), missing_to_zero)): object 'eas_all_s_rl' not found</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#TODO: (future) -- check for sensitivity to this imputation vs dropping these obs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="peeking-at-data-for-sanity-checks" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="peeking-at-data-for-sanity-checks"><span class="header-section-number">3.1</span> Peeking at data for sanity checks</h2>
<p>We report summary statistics on a selection of these features and target outcomes below…</p>
</section>
</section>
<section id="constructing-and-specifying-models" class="level1 unnumbered">
<h1 class="unnumbered">Constructing and specifying models</h1>
<section id="make-model-data-frames" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="make-model-data-frames"><span class="header-section-number">3.2</span> Make ‘model data frames’</h2>
</section>
</section>
<section id="report-model-results" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Report model results</h1>
<p>(tables and plots of results; latest years combined)</p>
<p>We put together forest plots of (normalized) coefficients from the distinct set of models outlined above, where these can be compared on the same scales. Specifically, we consider,</p>
<ul>
<li>for each of the three key outcomes (‘amount donated (averaged)’, ‘donation as a share of income’, ‘donated over 1000 USD’),</li>
<li>models with three specific sets of features, yielding nine models in total (plus robustness checks in the appendix).</li>
</ul>
<p>The feature sets, which we will refer to in the forest plots below, are:</p>

<!-- -->

</section>

<div id="quarto-appendix" class="default"><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1" role="doc-endnote"><p>Ideally, for replicablity, one reads data in directly from it’s earliest source, such as an API for the survey site where it was hosted.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Classical economic theory suggests that most goods are ‘normal’, with the amount consumed increasing in income. Empirical evidence supports this for charitable giving; <a href="https://econofact.org/are-rich-people-really-less-generous">recent work</a> suggests that <em>share of income</em> is relatively constant across the income distribution, implying that wealthier people give more in absolute terms.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>See further discussion in post.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>Here we focus on the average of last-year’s and next year’s donation for each individual, where both are present, and otherwise we use whichever one is present…. Further discussion in post.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>Where income is missing or where income was reported as 0 we impute it based on student status and country.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>We refer to the latter as “controls” because they aid our interpretation of other features of interest, as noted above. However, these are <em>also</em> of independent interest.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>Use <code>recipe</code> package for this if it makes it more organized, but it’s not necessary to use recipe if we are not doing machine learning, as leaks are not an issue, and we only need to do the imputation once. On the other hand, in non-prediction models we have a (bad?) tendency to assign a causal interpretation to particular features, and we need to be careful about how imputation might affect this.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb11" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Vignette: General (non-ML 'regression') modeling workflow"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">    citations-hover: true</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">    footnotes-hover: true</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">    freeze: auto # re-render only when source changes</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    warning: false</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">    message: false</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">    error: true</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="an">comments:</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">    hypothesis: true</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE}</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co">#or instead source(here("code", "methods_setup.R"))</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(rsample, <span class="at">install =</span> <span class="cn">FALSE</span>) <span class="co"># Why p_load these? (Can create issues with dependencies)</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(ggplot2, forcats, <span class="at">install =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(parsnip, tune, dials, <span class="at">install =</span> <span class="cn">FALSE</span>) <span class="co"># If loading multiple packages, better to use p_load with install = FALSE option</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(conflicted, workflowsets,  <span class="at">install=</span><span class="cn">FALSE</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(dynverse, <span class="at">install=</span><span class="cn">FALSE</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"set_label"</span>, <span class="st">"sjlabelled"</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"add_footnote"</span>, <span class="st">"kableExtra"</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"sample_n"</span>, <span class="st">"tidylog"</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>set_label <span class="ot">&lt;-</span> sjlabelled<span class="sc">::</span>set_label</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">&lt;-</span> dplyr<span class="sc">::</span>filter</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>ungroup <span class="ot">&lt;-</span> dplyr<span class="sc">::</span>ungroup</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>mutate <span class="ot">&lt;-</span> dplyr<span class="sc">::</span>mutate</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(devtools)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="fu">source_url</span>(<span class="st">"https://raw.githubusercontent.com/daaronr/dr-rstuff/master/functions/baseoptions.R"</span>)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="co">#github api yelled at me, and I had to do this: https://gist.github.com/Z3tt/3dab3535007acf108391649766409421</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"rethinkpriorities/rp-r-package"</span>, <span class="at">force =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinkpriorities)</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"rethinkpriorities/r-noodling-package"</span>)</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnoodling)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>This vignette </span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>shows how I define, build, and report (tables and plots) a set of 'models' in a (fairly) tidy, organized way  ...  </span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>for the simple intuitive/ad-hoc descriptive and causally suggestive models I did for the of the 2020 <span class="co">[</span><span class="ot">EA Forum post</span><span class="co">](https://forum.effectivealtruism.org/posts/nb6tQ5MRRpXydJQFq/ea-survey-2020-series-donation-data)</span> and <span class="co">[</span><span class="ot">chapter</span><span class="co">](https://rethinkpriorities.github.io/ea_data_public/eas_rps_own_style/eas_donations.html)</span>  and other EA forum posts posts</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>As a code example </span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a><span class="ss">     - </span>How the computation works and 'what is producing what' ... so that you can recreate it in your own context</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>To give a little bit of insight into the modeling choices and approaches.</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reading in data from a repo</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>The code below reads data in directly from the RP private github repo. You need to have authorization set up for this to work.^<span class="co">[</span><span class="ot">Ideally, for replicablity, one reads data in directly from it's earliest source, such as an API for the survey site where it was hosted.</span><span class="co">]</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a><span class="in">```{r input, include=FALSE}</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> rethinkpriorities<span class="sc">::</span><span class="fu">read_file_from_repo</span>(</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">repo =</span> <span class="st">"ea-data"</span>,</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="st">"data/edited_data/eas_all_s_rl_imp.Rdata"</span>,</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">user =</span> <span class="st">"rethinkpriorities"</span>,</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">token_key =</span> <span class="st">"github-API"</span>,</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="cn">TRUE</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>Next we sample from this data and remove labels, to make the process quicker and easier.</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r simplify_for_tidymodel}</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>  labelled<span class="sc">::</span><span class="fu">remove_attributes</span>(<span class="st">"label"</span>) <span class="sc">%&gt;%</span>  <span class="co"># Labels don't work with tidymodels :/, sadly</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">sample_n</span>(<span class="dv">2000</span>)</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a><span class="fu"># Modeling discussion </span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a><span class="fu">## Brief: our descriptive model 'selection'</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>In our *descriptive* modeling we do *not* remove 'insignificant' features from the model (as in stepwise regression), nor do we shrink the coefficients towards zero (as in Ridge and Lasso models). Under the assumptions of the classical linear model and its simple extensions the coefficients we present here would be unbiased or consistent. (However, we admit that the strong assumptions of this model, particularly those embodying exogeneity, are likely to fail in important ways in the current non-experimental setting.)</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a><span class="fu">## We retain those features of most direct interest</span></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>... (such as 'how introduced to EA') and/or theoretical importance (such as income),</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>^<span class="co">[</span><span class="ot">Classical economic theory suggests that most goods are 'normal', with the amount consumed increasing in income. Empirical evidence supports this for charitable giving; [recent work](https://econofact.org/are-rich-people-really-less-generous) suggests that *share of income* is relatively constant across the income distribution, implying that wealthier people give more in absolute terms.</span><span class="co">]</span> and 'controls' (especially time-in-EA and survey-year) that might allow us to better interpret the features of interest.^<span class="co">[</span><span class="ot">See further discussion in post.</span><span class="co">]</span></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a><span class="fu"># Choosing features and modeling targets, defining these lists/objects {.unnumbered}</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>**We focus on three key outcomes:**</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Amount donated (converted to US dollars)^<span class="co">[</span><span class="ot">Here we focus on the average of last-year's and next year's donation for each individual, where both are present, and otherwise we use whichever one is present.... Further discussion in post.</span><span class="co">]</span></span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Donation as a share of income^<span class="co">[</span><span class="ot">Where income is missing or where income was reported as 0 we impute it based on student status and country.</span><span class="co">]</span></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Whether donated more than 1000 USD</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>**We construct several 'feature sets':**</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"Key demographics, student status, and geography", used in all models </span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"Career/Economics": (Income, employment status, top-6 university)</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ^["Top-6 university" refers to whether the individual lists any of the six universities (Oxford, Stanford, Harvard, CalTech, MIT, Cambridge) appearing in the top-10 of all of USNWR, QS, and THE rankings. However, university was not asked in the 2018 survey ] --&gt;</span></span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"Pledges/commitments:" Whether ever taken a 'Giving What We Can Pledge', whether 'Earning to Give' <span class="co">&lt;!-- feat_gwwc_etg --&gt;</span></span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"Controls" for age, time-in-EA, and survey-year (used in all models)</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>^<span class="co">[</span><span class="ot">We refer to the latter as "controls" because they aid our interpretation of other features of interest, as noted above. However, these are *also* of independent interest.</span><span class="co">]</span></span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>**In the code below, we define these as objects!**</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>We define the lists of the different 'features' we care about as character vectors, to put into the models later. The idea is 'all decisions are specified and discussed up top', for better organization and control.</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>First we define the 'targets': the binary outcomes, numerical outcomes, all outcomes, and a subset of these outcomes for more involved analyses. </span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a><span class="in">```{r targets, echo=FALSE, warning=FALSE}</span></span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a><span class="co">#targets:</span></span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>bin_out <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"d_don_1k"</span>, <span class="st">"d_don_10pct"</span>)</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>num_out <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'donation_c'</span>, <span class="st">'don_av2_yr'</span>, <span class="st">'l_don_c'</span>, <span class="st">"l_don_av_2yr"</span>, <span class="st">"don_share_inc_imp_bc5k"</span>, <span class="st">"donation_plan_c"</span>)</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>targets <span class="ot">&lt;-</span> <span class="fu">c</span>(bin_out, num_out)</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>targets_short <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"don_av2_yr"</span>, <span class="st">"don_share_inc_imp_bc5k"</span>, <span class="st">"d_don_1k"</span>) </span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a><span class="co">#Note -- don_av2_yr is the right one for qpoisson as it already expresses things in exponents. l_don_av2_yr was the one to use in the loglinear model, which we are not emphasizing</span></span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>targets_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Log (Avg don +1)"</span>, <span class="st">"Don/Income"</span>, <span class="st">"Donated 1k+"</span>)</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>Next, we define  the 'features of interest' and the 'controls'</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a><span class="co">#features and controls</span></span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>geog <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"where_live_cat"</span>, <span class="st">"city_cat"</span>)</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>key_demog <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ln_age"</span>, <span class="st">"not_male_cat"</span>, <span class="st">"student_cat"</span>, <span class="st">"race_cat"</span>, geog)</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>key_demog_n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age_d2sd"</span>, <span class="st">"not_male_cat"</span>, <span class="st">"student_cat"</span>, <span class="st">"race_cat"</span>, geog)</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>feat_income_employ <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ln_income_c_imp_bc5k"</span>, <span class="st">"d_pt_employment"</span>, <span class="st">"d_not_employed"</span>, <span class="st">"d_top6_uni"</span>)</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a><span class="co">#Note -income_c_imp_diqr has been adjusted to  with 5k minimum</span></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>feat_income_employ_n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"income_c_imp_diqr"</span>, <span class="st">"d_pt_employment"</span>, <span class="st">"d_not_employed"</span>, <span class="st">"d_top6_uni"</span>)</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>feat_gwwc_etg <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"d_gwwc_ever_0"</span>, <span class="st">"d_career_etg"</span>)</span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>controls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ln_years_involved"</span>, <span class="st">"year_f"</span>) <span class="co">#note this assumes those 2009 or earlier started in 2009</span></span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>controls_n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"years_involved_d2sd"</span>, <span class="st">"year_f"</span>) <span class="co">#note this assumes those 2009 or earlier started in 2009</span></span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>robust_controls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ln_years_involved_post_med"</span>,  <span class="st">"ln_age_if_older"</span>, <span class="st">"ln_income_c_imp_if_richer"</span>)</span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>robust_controls_n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"years_inv_d2sd_post_med"</span>,  <span class="st">"age_d2sd_post_med"</span>, <span class="st">"income_c_imp_diqr_if_richer"</span>)</span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a><span class="co">#note -- I swapped "age_ranges" for "gender_d2sd" because this will allow us a decent measure of 'is the age effect nonlinear' (see datacolada on the superiority of this over a quadratic)</span></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a><span class="co">#contrasts(normtimeBP02$Nasality) = contr.treatment(4)</span></span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a><span class="co">#DR; I was never able to get the contrasts thing to work so I went with 'base group is most common group'</span></span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r key_eas_all_labels}</span></span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>key_eas_all_labels <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="co">#note these are converted to a list with as.list before assigning them</span></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">donation_usd =</span> <span class="st">"Donation (USD)"</span>,</span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">l_don_usd =</span> <span class="st">"Log Don. (USD)"</span>,</span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>    <span class="at">l_don_av_2yr =</span> <span class="st">"Log Don. 'avg.'"</span>,</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>    <span class="at">ln_age =</span> <span class="st">"Log age"</span>,</span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">don_av2_yr =</span> <span class="st">"Don. 'avg'"</span>,</span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>    <span class="at">donation_plan_usd =</span> <span class="st">"Don. plan (USD)"</span>)</span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a><span class="fu"># Ad-hoc data cleaning, recipes</span></span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>We impute a few missings, etc, just for modeling.^<span class="co">[</span><span class="ot">Use `recipe` package for this if it makes it more organized, but it's not necessary to use recipe if we are not doing machine learning, as leaks are not an issue, and we only need to do the imputation once. On the other hand, in non-prediction models we have a (bad?) tendency to assign a causal interpretation to particular features, and we need to be careful about how imputation might affect this.</span><span class="co">]</span></span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>Below, some e imputations and constructed features (for functional form interpretation) that I did in the 'actual analysis'.</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r impute_norm_features, warning=FALSE}</span></span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a><span class="co">#We impute variables where missing and normalizing all variables to be mean-zero and to be on the same scale.</span></span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>diqr <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>  (x <span class="sc">-</span> <span class="fu">mean</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>))<span class="sc">/</span><span class="fu">IQR</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>gtmed <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">*</span>(x<span class="sc">&gt;</span><span class="fu">med</span>(x))</span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a>eas_all_s <span class="ot">&lt;-</span> eas_all <span class="sc">%&gt;%</span></span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(don_av2_yr) <span class="sc">&amp;</span> year_f <span class="sc">%in%</span> last_3_years) <span class="sc">%&gt;%</span></span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a>    <span class="co">#(re) code scaling and 2-part splits for the modeling sample (2018-20, reporting donations)</span></span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_d2sd =</span> arm<span class="sc">::</span><span class="fu">rescale</span>(age), <span class="co">#Todo (automate this with `mutate(across)` thing)</span></span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>    <span class="at">years_involved_d2sd =</span> arm<span class="sc">::</span><span class="fu">rescale</span>(year <span class="sc">-</span> <span class="fu">as.numeric</span>(year_involved)),</span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>    <span class="at">years_inv_d2sd_post_med =</span> <span class="fu">gtmed</span>(years_involved_d2sd),</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">income_c_imp_diqr =</span> <span class="fu">diqr</span>(income_c_imp_bc5k),</span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_d2sd_post_med =</span> arm<span class="sc">::</span><span class="fu">rescale</span>(age_if_older),</span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">income_c_imp_diqr_if_richer =</span> <span class="fu">gtmed</span>(income_c_imp_diqr),</span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">ln_income_c_imp_if_richer=</span> <span class="fu">gtmed</span>(ln_income_c_imp_bc5k)</span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">don_share_inc_imp_bc5k =</span> <span class="fu">min</span>(don_share_inc_imp_bc5k, <span class="dv">1</span>)) <span class="sc">%&gt;%</span>  <span class="co">#recode about 84 values so the range is between 0-1 for frac. logit to work</span></span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(num_out, bin_out, controls, key_demog, feat_income_employ, feat_gwwc_etg, robust_controls)),</span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>                income_c, income_c_imp, income_c_imp_bc5k, income_c_imp_diqr, income_c_imp_diqr_if_richer, first_hear_ea_lump, years_involved, age,</span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>                <span class="fu">contains</span>(<span class="st">"d2sd"</span>), <span class="fu">contains</span>(<span class="st">"iqr"</span>)) <span class="sc">%&gt;%</span> <span class="co">#I have added first_hear_ea_lump back even though we don't use it here because we want to use it in ML; I hope it doesn't mess anything up</span></span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a>  <span class="co"># years_involved included to put in sumstats</span></span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>  labelled<span class="sc">::</span><span class="fu">set_variable_labels</span>(<span class="at">.labels =</span> <span class="fu">as.list</span>(key_eas_all_labels), <span class="at">.strict=</span><span class="cn">FALSE</span>)</span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Recode missing as 0 for all dummies, as a 'NA category' for categoricals</span></span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a>  <span class="co">#also for normalized variables; i.e., set missings to the mean</span></span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a>eas_all_s_rl <span class="ot">&lt;-</span> eas_all_s <span class="sc">%&gt;%</span></span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"d_|not_just_white"</span>), missing_to_zero))</span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>eas_all_s_rl_imp <span class="ot">&lt;-</span> eas_all_s_rl <span class="sc">%&gt;%</span></span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"d2sd|diqr"</span>), missing_to_zero)) <span class="sc">%&gt;%</span></span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>    labelled<span class="sc">::</span><span class="fu">set_variable_labels</span>(<span class="at">.labels =</span> <span class="fu">as.list</span>(key_eas_all_labels), <span class="at">.strict=</span><span class="cn">FALSE</span>)</span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a><span class="co">#TODO: (future) -- check for sensitivity to this imputation vs dropping these obs</span></span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a><span class="fu">## Peeking at data for sanity checks </span></span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>We report summary statistics on a selection of these features and target outcomes below...</span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a><span class="fu"># Constructing and specifying models {.unnumbered}</span></span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a><span class="fu">## Make 'model data frames'</span></span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a><span class="fu"># Report model results</span></span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a>(tables and plots of results; latest years combined) </span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a>We put together forest plots of (normalized) coefficients from the distinct set of models outlined above, where these can be compared on the same scales. Specifically, we consider,</span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>for each of the three key outcomes ('amount donated (averaged)',</span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a>    'donation as a share of income', 'donated over 1000 USD'),</span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>models with three specific sets of features, yielding nine models in total (plus robustness checks in the appendix).</span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>The feature sets, which we will refer to in the forest plots below, are:</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->


</body></html>